# 种子用户

在我们的测试套件中，一切看起来都很棒。

我们还没有对最新的功能进行任何探索性测试——我们停止了在浏览器中的胡乱操作，
几乎是在开始研究快乐路径的同时。这并非
巧合——我们目前无法进行快乐路径测试！

数据库中没有用户，也没有管理员注册流程——我们隐含的期望是
应用程序所有者会以某种方式成为新闻通讯的首位管理员！
现在是时候实现这一点了。

我们将创建一个种子用户——即添加一个迁移文件，在应用程序首次部署时将用户创建到数据库中。

种子用户将拥有一个预先确定的用户名和密码；

然后他们将能够在首次登录后更改密码。

## 数据库迁移

让我们使用 `sqlx` 创建一个新的迁移

```shell
sqlx migrate add seed_user
```

我们需要在用户表中插入一行新数据。我们需要:

- 用户 ID (UUID)
- 用户名
- PHC 字符串

选择您喜欢的 UUID 生成器来获取有效的用户 ID。我们将使用 `admin` 作为用户名。

获取 PHC 字符串稍微麻烦一些——我们将使用 `everythinghastostartsomewhere` 作为密码，

但如何生成相应的 PHC 字符串呢?

我们可以利用我们在测试套件中编写的代码来“作弊”:

```rs
//! tests/api/helpers.rs
// [...]

impl TestUser {
    pub fn generate() -> Self {
        Self {
            // [...]
            // password: Uuid::new_v4().to_string(),
            password: "everythinghastostartsomewhere".into(),
        }
    }

    async fn store(&self, pool: &PgPool) {
        // [...]
        let password_hash = /* */;
        dbg!(&password_hash);
        // [...]
    }
}
```

这只是一个临时的修改——之后只需运行 `cargo test -- --nocapture` 即可为我们的迁移脚本获取格式正确的 PHC 字符串。获取后请还原更改。

迁移脚本如下所示:

```sql
INSERT INTO users (user_id, username, password_hash)
VALUES (
  'ddf8994f-d522-4659-8d02-c1d479057be6',
  'admin',
  '$argon2id$v=19$m=15000,t=2,p=1$fA5tDKcNuhzfD6UD1Hmlsw$TN5KrFnqlxJBY7LUFpsV9OZZ/u0wKklR/KrRrzIras0'
);
```

```shell
sqlx migrate run
```

运行迁移，然后使用 `cargo run` 启动你的应用程序 - 你最终应该能够成功登录！

如果一切正常, `/admin/dashboard` 上应该会出现一条 "Welcome admin" 的消息。

恭喜!
